<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MandorLine - Riwayat Laporan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1565C0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="logo.png">

    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700;900&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#1565C0"
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Public Sans', sans-serif;
            background: #f8fafc;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .shimmer {
            background: linear-gradient(90deg, #f3f4f6 25%, #f9fafb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .cursor-zoom-in {
            cursor: zoom-in;
        }

        /* Spinner for Zoom Loading */
        .zoom-loader {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="text-slate-900 leading-tight">
    <div class="max-w-md mx-auto min-h-screen bg-[#f1f5f9] relative pb-28 shadow-2xl">

        <!-- Premium Blue Header -->
        <header class="sticky top-0 z-50 bg-[#1565C0] shadow-[0_4px_20px_rgba(21,101,192,0.3)] rounded-b-[2.5rem]">
            <div class="flex items-center justify-between p-6 pb-8 max-w-md mx-auto">
                <div class="flex items-center gap-4">
                    <button onclick="window.location.href='patroli-step1.html'"
                        class="size-11 flex items-center justify-center rounded-2xl bg-white/10 text-white hover:bg-white/20 active:scale-90 transition-all backdrop-blur-md">
                        <span class="material-symbols-outlined">arrow_back</span>
                    </button>
                    <div>
                        <h1 class="text-xl font-black text-white leading-none tracking-tight">Monitoring</h1>
                        <p class="text-[10px] font-bold text-blue-100 opacity-70 uppercase tracking-[0.2em] mt-1.5">
                            Database Temuan</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="fetchData()"
                        class="size-11 flex items-center justify-center rounded-2xl bg-white/10 text-white hover:bg-white/20 active:scale-90 transition-all backdrop-blur-md"
                        title="Sync Data">
                        <span class="material-symbols-outlined text-[22px]">sync</span>
                    </button>
                    <button onclick="previewAll()"
                        class="size-11 flex items-center justify-center rounded-2xl bg-white text-primary shadow-xl hover:bg-blue-50 active:scale-90 transition-all"
                        title="Download PDF">
                        <span class="material-symbols-outlined text-[22px]">picture_as_pdf</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Smart Search & Filter -->
        <div class="px-6 mt-6 space-y-3">
            <div class="relative">
                <input type="text" id="searchInput" oninput="applyFilters()"
                    placeholder="Cari No Kondisi, Petugas, atau Lokasi..."
                    class="w-full h-14 bg-white rounded-2xl border-none shadow-sm px-14 text-sm focus:ring-2 focus:ring-blue-500 transition-all outline-none">
                <span class="material-symbols-outlined absolute left-5 top-4 text-slate-300">search</span>
                <button onclick="resetFilters()" class="absolute right-4 top-4 text-slate-300 hover:text-red-400">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="flex gap-2 overflow-x-auto no-scrollbar py-1">
                <div id="quickStatus" class="flex gap-2 w-full">
                    <button onclick="setQuickStatus('all')"
                        class="status-btn active px-5 py-2.5 rounded-full border border-red-600 bg-red-600 text-white text-[10px] font-black uppercase shadow-sm transition-all whitespace-nowrap">Semua</button>
                    <button onclick="setQuickStatus('open')"
                        class="status-btn px-5 py-2.5 rounded-full border border-slate-100 bg-white text-slate-500 text-[10px] font-black uppercase shadow-sm transition-all whitespace-nowrap">Open</button>
                    <button onclick="setQuickStatus('progress')"
                        class="status-btn px-5 py-2.5 rounded-full border border-slate-100 bg-white text-slate-500 text-[10px] font-black uppercase shadow-sm transition-all whitespace-nowrap">Progress</button>
                    <button onclick="setQuickStatus('closed')"
                        class="status-btn px-5 py-2.5 rounded-full border border-slate-100 bg-white text-slate-500 text-[10px] font-black uppercase shadow-sm transition-all whitespace-nowrap">Closed</button>
                </div>
            </div>
        </div>

        <!-- Quick Stats Card -->
        <div class="px-6 mt-6 grid grid-cols-2 gap-4">
            <div
                class="bg-white p-5 rounded-[2rem] shadow-sm border border-slate-50 flex items-center gap-4 transition-all hover:shadow-md">
                <div
                    class="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center text-blue-600 shadow-inner">
                    <span class="material-symbols-outlined text-2xl">assignment</span>
                </div>
                <div>
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Total</p>
                    <p class="text-sm font-black text-slate-800" id="statTotal">0</p>
                </div>
            </div>
            <div
                class="bg-white p-5 rounded-[2rem] shadow-sm border border-slate-50 flex items-center gap-4 transition-all hover:shadow-md">
                <div
                    class="w-12 h-12 bg-emerald-50 rounded-2xl flex items-center justify-center text-emerald-600 shadow-inner">
                    <span class="material-symbols-outlined text-2xl">account_tree</span>
                </div>
                <div>
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Penyulang</p>
                    <p class="text-sm font-black text-slate-800" id="statPenyulang">0</p>
                </div>
            </div>
        </div>

        <!-- Compact Zebra List -->
        <section class="mt-8 px-6 pb-4">
            <!-- Header dihapus sesuai permintaan -->

            <div id="loading" class="space-y-3">
                <div class="h-16 w-full rounded-2xl shimmer"></div>
                <div class="h-16 w-full rounded-2xl shimmer"></div>
                <div class="h-16 w-full rounded-2xl shimmer"></div>
            </div>

            <div id="reportContainer"
                class="hidden overflow-hidden rounded-3xl border border-slate-100 shadow-sm bg-white divide-y divide-slate-50">
                <!-- List will be injected here -->
            </div>
        </section>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md bg-white/95 backdrop-blur-xl border-t border-slate-100 p-3 pb-3 px-12 flex justify-between items-center z-40 rounded-t-[2.5rem] shadow-xl"
            style="padding-bottom: calc(0.3rem + env(safe-area-inset-bottom, 0px));">
            <button onclick="window.location.href='patroli-step1.html'"
                class="flex flex-col items-center gap-1 text-slate-300 active:scale-95">
                <span class="material-symbols-outlined text-2xl">add_circle</span>
                <span class="text-[8px] font-black uppercase tracking-widest">Baru</span>
            </button>
            <button class="flex flex-col items-center gap-1 text-blue-600">
                <span class="material-symbols-outlined text-2xl">assignment</span>
                <span class="text-[8px] font-black uppercase tracking-widest">History</span>
            </button>
            <button onclick="showLogoutModal()" class="flex flex-col items-center gap-1 text-slate-300 active:scale-95">
                <span class="material-symbols-outlined text-2xl">logout</span>
                <span class="text-[8px] font-black uppercase tracking-widest">Keluar</span>
            </button>
        </nav>
    </div>

    <!-- Premium Logout Modal -->
    <div id="logoutModal" class="fixed inset-0 z-[100] hidden items-center justify-center p-6">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm animate-fade-in" onclick="hideLogoutModal()">
        </div>
        <div class="bg-white w-full max-w-xs rounded-[2.5rem] p-8 shadow-2xl relative z-10 scale-90 opacity-0 transition-all duration-300 transform"
            id="logoutModalContent">
            <div
                class="w-18 h-18 bg-white border-2 border-slate-100 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg p-2">
                <img src="logo.png" class="w-12 h-12 object-contain">
            </div>
            <h3 class="text-xl font-black text-center text-slate-900 mb-2">Keluar Aplikasi?</h3>
            <p class="text-xs text-slate-500 text-center leading-relaxed mb-8">Anda akan diarahkan kembali ke halaman
                login.</p>
            <div class="flex flex-col gap-3">
                <button onclick="window.location.href='index.html'"
                    class="w-full h-14 bg-[#1565C0] text-white rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg shadow-blue-200 active:scale-95 transition-all">Ya,
                    Keluar</button>
                <button onclick="hideLogoutModal()"
                    class="w-full h-14 bg-slate-50 text-slate-600 rounded-2xl font-black text-xs uppercase tracking-widest active:scale-95 transition-all">Batalkan</button>
            </div>
        </div>
    </div>


    <!-- Detail Swipe-up -->
    <div id="detailView"
        class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm translate-y-full transition-all duration-500 overflow-y-auto no-scrollbar hidden">
        <div class="max-w-md mx-auto min-h-screen bg-white relative shadow-2xl rounded-t-[3rem] mt-10 p-6 pt-2">
            <div class="w-12 h-1.5 bg-slate-100 rounded-full mx-auto my-4"></div>
            <div class="flex justify-between items-center mb-6">
                <div>
                    <p class="text-[10px] font-black text-blue-600 uppercase tracking-widest" id="detNoKondisi">HAR-XXXX
                    </p>
                    <h2 class="text-2xl font-black text-slate-900 mt-1">Detail Laporan</h2>
                </div>
                <button onclick="closeDetail()"
                    class="w-12 h-12 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 active:scale-90 transition-all">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div id="detContent" class="space-y-6 pb-12">
                <!-- Details injected here -->
            </div>
        </div>
    </div>

    <!-- Photo Zoom Modal (Jurus Zoom In) -->
    <div id="photoZoomModal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/95 backdrop-blur-lg animate-fade-in" onclick="closeZoom()"></div>

        <!-- Loading Spinner -->
        <div id="zoomSpinner" class="absolute z-10 hidden">
            <div class="zoom-loader"></div>
        </div>

        <div class="relative w-full max-w-md scale-90 opacity-0 transition-all duration-300 transform" id="zoomContent">
            <img id="zoomedImg" src="" class="w-full h-auto rounded-[2.5rem] shadow-2xl border-2 border-white/20"
                onload="hideZoomSpinner()">
            <button onclick="closeZoom()"
                class="absolute -top-4 -right-4 w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-2xl active:scale-90 text-slate-900 transition-transform">
                <span class="material-symbols-outlined font-black">close</span>
            </button>
        </div>
    </div>

    <script>
        // SOLUSI UNTUK KONEKSI GAGAL TERUS:
        // Gunakan Proxy AllOrigins sebagai jembatan agar tidak kena blokir CORS/Google Redirect
        const URL1 = 'https://script.google.com/macros/s/AKfycbxkmCbtd8jWmVGZ2MAIo9mUKrnxfZsuS4X07D7wM3-2vkQhLQbyJX5rnJNz3l80d_aNuA/exec';
        const URL2 = 'https://script.google.com/macros/s/AKfycbyP51OxeWQTU02m8n1wSAuVGXS5auxK7o-AJGYqUgorZ9ZpInUgqlM22ikiTESBXg7J8g/exec';

        let allData = [];
        let filteredData = [];
        let activeStatus = 'all';

        async function fetchData() {
            const loading = document.getElementById('loading');
            const container = document.getElementById('reportContainer');
            loading.classList.remove('hidden');
            container.classList.add('hidden');

            async function pullData() {
                // Daftar target URL dan Proxy yang akan dicoba
                const targets = [URL1, URL2];
                const proxies = [
                    (u) => `${u}?t=${Date.now()}`, // Langsung
                    (u) => `https://api.allorigins.win/get?v=${Date.now()}&url=${encodeURIComponent(u + '?t=' + Date.now())}`, // AllOrigins
                    (u) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u + '?t=' + Date.now())}` // CodeTabs
                ];

                for (let target of targets) {
                    for (let getProxy of proxies) {
                        try {
                            const res = await fetch(getProxy(target));
                            let json = await res.json();
                            // Handle AllOrigins wrapper
                            if (json && json.contents) json = JSON.parse(json.contents);
                            if (json) return json;
                        } catch (e) {
                            console.warn("Retrying with another proxy/URL...");
                        }
                    }
                }
                throw new Error("Gagal terhubung ke Database Utama maupun Backup.");
            }

            try {
                const data = await pullData();
                renderWithData(data);
            } catch (err) {
                console.error(err);
                container.classList.remove('hidden');
                container.innerHTML = `
                    <div class="py-20 text-center px-8">
                        <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="material-symbols-outlined text-3xl text-red-400">cloud_off</span>
                        </div>
                        <h3 class="text-slate-800 font-black text-sm">Koneksi Database Gagal</h3>
                        <p class="text-[10px] text-slate-400 mt-2">${err.message}</p>
                        <button onclick="fetchData()" class="mt-8 w-full py-4 bg-blue-600 text-white font-black text-[11px] rounded-2xl shadow-lg active:scale-95 transition-all">COBA LAGI</button>
                    </div>
                `;
            } finally {
                loading.classList.add('hidden');
            }
        }

        // JURUS PAMUNGKAS: Super Parser yang bisa deteksi format Object {} maupun Array []
        function renderWithData(data) {
            let list = Array.isArray(data) ? data : (data.reports || data.data || []);

            // Simpan raw untuk debug
            window.rawDatabase = data;

            // Jika formatnya Array of Arrays (Header di baris 1)
            if (list.length > 1 && Array.isArray(list[0])) {
                const head = list[0].map(h => h.toString().toLowerCase().replace(/[^a-z0-9]/g, ''));
                list = list.slice(1).map(row => {
                    const o = {};
                    row.forEach((v, i) => { if (head[i]) o[head[i]] = v; });
                    return o;
                });
            }

            // Normalisasi TOTAL semua Key
            allData = list.map(item => {
                if (typeof item !== 'object' || item === null) return null;
                const clean = {};
                for (let k in item) {
                    const ck = k.toString().toLowerCase().replace(/[^a-z0-9]/g, '');
                    clean[ck] = item[k];
                }
                return clean;
            }).filter(Boolean).reverse();

            // Debug Helper: Klik Judul "Detail Laporan" 5x untuk intip Data Asli
            let clickCount = 0;
            document.querySelector('h2').onclick = () => {
                clickCount++;
                if (clickCount >= 5) {
                    alert("DEBUG MODE:\n" + JSON.stringify(allData[0] || "Data Kosong", null, 2));
                    clickCount = 0;
                }
            };

            /* Dropdown Penyulang dihapus sesuai permintaan */
            applyFilters();
        }

        function setQuickStatus(val) {
            activeStatus = val;
            const configs = {
                all: { color: 'bg-red-600', border: 'border-red-600' },
                open: { color: 'bg-emerald-500', border: 'border-emerald-500' },
                progress: { color: 'bg-yellow-500', border: 'border-yellow-500' },
                closed: { color: 'bg-blue-600', border: 'border-blue-600' }
            };

            document.querySelectorAll('.status-btn').forEach(b => {
                const bVal = b.getAttribute('onclick').match(/'(.*)'/)[1];
                b.classList.remove('active', 'bg-blue-600', 'bg-slate-800', 'bg-red-600', 'bg-emerald-500', 'bg-yellow-500', 'text-white', 'border-blue-600', 'border-slate-800', 'border-red-600', 'border-emerald-500', 'border-yellow-500');
                b.classList.add('bg-white', 'text-slate-500', 'border-slate-100');

                if (bVal === val) {
                    const c = configs[val];
                    b.classList.add('active', c.color, 'text-white', c.border);
                    b.classList.remove('bg-white', 'text-slate-500', 'border-slate-100');
                }
            });
            applyFilters();
        }

        function applyFilters() {
            const query = document.getElementById('searchInput').value.toLowerCase();

            filteredData = allData.filter(d => {
                const searchStr = `${d.nokondisi} ${d.namapetugas} ${d.penyulang} ${d.lokasi}`.toLowerCase();
                const matchSearch = !query || searchStr.includes(query);

                const s = (d.status || 'OPEN').toLowerCase();
                const matchStatus = activeStatus === 'all' ||
                    (activeStatus === 'open' && s.includes('open')) ||
                    (activeStatus === 'progress' && s.includes('progress')) ||
                    (activeStatus === 'closed' && (s.includes('close') || s.includes('selesai')));

                return matchSearch && matchStatus;
            });

            renderUI();
        }

        function renderUI() {
            const c = document.getElementById('reportContainer');
            c.innerHTML = '';
            c.classList.remove('hidden');

            if (document.getElementById('statTotal')) document.getElementById('statTotal').innerText = allData.length;
            if (document.getElementById('statPenyulang')) document.getElementById('statPenyulang').innerText = new Set(allData.map(d => d.penyulang).filter(Boolean)).size;
            if (document.getElementById('dataCount')) document.getElementById('dataCount').innerText = `${filteredData.length} Laporan`;

            if (filteredData.length === 0) {
                c.innerHTML = '<div class="py-14 text-center text-slate-300 font-bold text-[10px] uppercase tracking-widest">Tidak ada data ditemukan</div>';
                return;
            }

            c.className = "overflow-hidden rounded-3xl border border-slate-100 shadow-sm bg-white divide-y divide-slate-50";

            filteredData.forEach((d, i) => {
                const s = (d.status || '').toLowerCase();
                const isClosed = s.includes('close') || s.includes('selesai');
                const isProgress = s.includes('progress');
                const statusText = (d.status || (isClosed ? 'CLOSED' : 'OPEN')).toUpperCase();

                let statusBadge = "";
                if (isClosed) {
                    statusBadge = `<span class="flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[9px] font-black uppercase bg-blue-50 text-blue-600 border border-blue-100/50 shadow-sm"><span class="w-1.5 h-1.5 rounded-full bg-blue-500 shadow-[0_0_5px_rgba(59,130,246,0.5)]"></span>${statusText}</span>`;
                } else if (isProgress) {
                    statusBadge = `<span class="flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[9px] font-black uppercase bg-yellow-50 text-yellow-600 border border-yellow-100/50 shadow-sm"><span class="w-1.5 h-1.5 rounded-full bg-yellow-500 animate-pulse shadow-[0_0_8px_rgba(245,158,11,0.6)]"></span>${statusText}</span>`;
                } else {
                    statusBadge = `<span class="flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[9px] font-black uppercase bg-sky-50 text-sky-600 border border-sky-100/50 shadow-sm"><span class="w-1.5 h-1.5 rounded-full bg-sky-500 animate-pulse shadow-[0_0_8px_rgba(14,165,233,0.6)]"></span>${statusText}</span>`;
                }

                const row = `
                    <div onclick="showDetail(${i})" class="${i % 2 !== 0 ? 'bg-blue-50/30' : 'bg-white'} px-6 py-2.5 active:bg-blue-100 flex items-center gap-4 cursor-pointer transition-all border-b border-slate-50 last:border-none">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="text-[13px] font-black text-slate-800">${d.nokondisi || '-'}</span>
                                ${statusBadge}
                            </div>
                            <div class="flex items-center justify-between mt-0.5 opacity-80">
                                <p class="text-[11px] font-bold uppercase truncate pr-4 text-slate-500">${d.penyulang || '-'} • ${d.namapetugas || '-'}</p>
                                <p class="text-[10px] font-semibold text-slate-400">${(d.waktupatroli || '').split(',')[0]}</p>
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-slate-300 text-sm">chevron_right</span>
                    </div>
                `;
                c.insertAdjacentHTML('beforeend', row);
            });
        }

        // Helper untuk mengambil nilai dengan kunci yang fleksibel
        function getV(obj, ...keys) {
            if (!obj) return "-";
            for (let k of keys) {
                const cleanK = k.toLowerCase().replace(/[^a-z0-9]/g, '');
                if (obj[cleanK] !== undefined && obj[cleanK] !== null && obj[cleanK] !== "") return obj[cleanK];
            }
            // Tambahan: Cari yang mengandung kata (Partial Match) jika tidak ketemu exact
            for (let key in obj) {
                for (let k of keys) {
                    const ck = k.toLowerCase().replace(/[^a-z0-9]/g, '');
                    if (key.includes(ck)) return obj[key];
                }
            }
            return "-";
        }

        // Helper pintar untuk mencari foto (Cek Key -> Cek Posisi -> Cek URL)
        function findPhoto(obj, indexPrefer, ...keys) {
            // 1. Cek berdasarkan Key (Nama Kolom)
            for (let k of keys) {
                const ck = k.toLowerCase().replace(/[^a-z0-9]/g, '');
                for (let key in obj) {
                    if (key.includes(ck)) {
                        const val = obj[key]?.toString().trim();
                        if (val && val.startsWith('http')) return val;
                    }
                }
            }
            // 2. Cek berdasarkan Urutan Kolom (Posisi) - Link biasanya Col 12,13,14
            const values = Object.values(obj);
            if (values[indexPrefer] && values[indexPrefer].toString().startsWith('http')) {
                return values[indexPrefer].toString().trim();
            }
            // 3. Scan Total: Cari apapun yang mengandung "ibb.co" atau "http" tapi bukan field lain
            for (let v of values) {
                const s = v?.toString().trim();
                if (s && s.startsWith('http') && (s.includes('ibb.co') || s.includes('imgbb'))) return s;
            }
            return "-";
        }

        function showDetail(idx) {
            const d = filteredData[idx];
            if (!d) return;

            // Status Logic for Detail View
            const isClosed = (d.status || '').toLowerCase().includes('close') || (d.status || '').toLowerCase().includes('selesai');
            const statusText = (d.status || (isClosed ? 'OK' : 'OPEN')).toUpperCase();

            // Mapping Super Jitu untuk Gambar (Prioritas Nama -> Urutan -> Scan)
            const f1 = findPhoto(d, 12, 'link1', 'foto1', 'kondisi', 'temuan', 'gambar1');
            const f2 = findPhoto(d, 13, 'link2', 'foto2', 'detail', 'jarak', 'gambar2');
            const fA = findPhoto(d, 14, 'linkaction', 'fotoaction', 'tindakan', 'perbaikan', 'gambar3', 'action');

            document.getElementById('detNoKondisi').innerText = getV(d, 'nokondisi', 'no', 'kode');
            const c = document.getElementById('detContent');

            console.log("Detail Data:", d);

            c.innerHTML = `
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-slate-50 p-5 rounded-[2.5rem]">
                        <p class="text-[8px] font-black uppercase text-slate-400">Petugas</p>
                        <p class="text-xs font-black truncate">${getV(d, 'namapetugas', 'petugas', 'nama')}</p>
                    </div>
                    <div class="bg-slate-50 p-5 rounded-[2.5rem]">
                        <p class="text-[8px] font-black uppercase text-slate-400">Penyulang</p>
                        <p class="text-xs font-black truncate">${getV(d, 'penyulang', 'feeder')}</p>
                    </div>
                </div>

                <div class="bg-blue-600 p-6 rounded-[2.5rem] text-white shadow-xl shadow-blue-100 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"></div>
                    <p class="text-[8px] font-black uppercase tracking-widest text-white/50">Temuan Utama</p>
                    <h4 class="text-lg font-black mt-1 leading-tight">${getV(d, 'jenistemuan', 'temuan', 'kerusakan')}</h4>
                    <div class="mt-4 p-4 bg-black/10 rounded-2xl text-[11px] italic leading-relaxed">
                        "${getV(d, 'keterangan', 'catatan', 'deskripsi', 'uraian')}"
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    ${renderImg(f1, "Kondisi")}
                    ${renderImg(f2, "Detail")}
                    <div class="col-span-2">${renderImg(fA, "Action Taken")}</div>
                </div>

                <div class="bg-[#1565C0] text-white/80 p-8 rounded-[3rem] space-y-4 shadow-xl shadow-blue-900/20">
                    <div class="flex justify-between items-start border-b border-white/20 pb-4">
                       <div>
                           <p class="text-[8px] uppercase text-white/50 tracking-widest">Pelaksana</p>
                           <p class="text-xs font-black mt-1 text-white">${getV(d, 'pelaksana')}</p>
                       </div>
                       <div class="text-right">
                           <p class="text-[8px] uppercase text-white/50 tracking-widest">Prioritas</p>
                           <p class="text-xs font-black mt-1 text-amber-400">${getV(d, 'prioritas')}</p>
                       </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-[8px] uppercase text-white/50 tracking-widest mb-1.5">Status Laporan</p>
                            ${isClosed
                    ? `<span class="flex items-center gap-2 px-4 py-1.5 rounded-xl text-[10px] font-black uppercase bg-white/20 text-white border border-white/30"><span class="w-2 h-2 rounded-full bg-white shadow-[0_0_10px_rgba(255,255,255,0.5)]"></span>${statusText}</span>`
                    : `<span class="flex items-center gap-2 px-4 py-1.5 rounded-xl text-[10px] font-black uppercase bg-sky-400/20 text-sky-200 border border-sky-400/30"><span class="w-2 h-2 rounded-full bg-sky-300 animate-pulse shadow-[0_0_10px_rgba(125,211,252,0.5)]"></span>${statusText}</span>`
                }
                        </div>
                        <div class="text-right">
                            <p class="text-[8px] uppercase text-white/50 tracking-widest mb-1">Cuaca</p>
                            <p class="text-[10px] font-bold text-white">${getV(d, 'cuaca', 'weather')}</p>
                        </div>
                    </div>
                    <div>
                        <p class="text-[8px] uppercase text-white/50 tracking-widest mb-1">Koordinat/Lokasi</p>
                        <p class="text-[10px] leading-relaxed italic text-white/90">${getV(d, 'lokasi')}</p>
                    </div>
                </div>
            `;

            document.getElementById('detailView').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('detailView').classList.remove('translate-y-full');
            }, 50);
        }

        function renderImg(u, l) {
            if (!u || u.length < 10 || u === '-') {
                return `
                    <div class="aspect-square bg-slate-50 rounded-[2.5rem] flex flex-col items-center justify-center text-slate-300 border-2 border-dashed border-slate-100">
                        <span class="material-symbols-outlined text-3xl mb-1">image_not_supported</span>
                        <span class="text-[8px] font-bold uppercase">${l}</span>
                    </div>
                `;
            }

            // JURUS ANTI-BLOKIR ISP: Gunakan Image Proxy (weserv.nl)
            // Ini akan mengambil gambar lewat server lain supaya tidak kena blokir provider lokal
            let proxyUrl = u;
            if (u.includes('ibb.co')) {
                // Bersihkan URL (pastikan tidak ada spasi/titik di ujung)
                const cleanUrl = u.trim().split('?')[0];
                proxyUrl = `https://images.weserv.nl/?url=${encodeURIComponent(cleanUrl)}`;
            }

            return `
                <div class="relative aspect-square rounded-[2.5rem] overflow-hidden shadow-sm border border-slate-100 transition-all hover:shadow-md cursor-zoom-in" onclick="zoomPhoto('${proxyUrl}')">
                    <img src="${proxyUrl}" 
                         referrerpolicy="no-referrer" 
                         crossorigin="anonymous"
                         class="w-full h-full object-cover" 
                         loading="lazy"
                         onerror="this.src='${u}'; this.onerror=null;">
                    <div class="absolute bottom-3 left-3 right-3 bg-white/90 backdrop-blur-md px-3 py-2 rounded-2xl text-[8px] font-black uppercase text-center text-slate-600 border border-slate-100">
                        ${l}
                    </div>
                </div>
            `;
        }

        /* ── Jurus Zoom Photo ── */
        function zoomPhoto(url) {
            const m = document.getElementById('photoZoomModal');
            const img = document.getElementById('zoomedImg');
            const cont = document.getElementById('zoomContent');
            const spinner = document.getElementById('zoomSpinner');

            // Reset state
            cont.classList.replace('scale-100', 'scale-90');
            cont.classList.replace('opacity-100', 'opacity-0');

            spinner.classList.remove('hidden');
            img.src = url;

            m.classList.remove('hidden');
            m.classList.add('flex');

            setTimeout(() => {
                cont.classList.add('scale-100', 'opacity-100');
                cont.classList.remove('scale-90', 'opacity-0');
            }, 50);
        }

        function hideZoomSpinner() {
            document.getElementById('zoomSpinner').classList.add('hidden');
        }

        function closeZoom() {
            const m = document.getElementById('photoZoomModal');
            const cont = document.getElementById('zoomContent');

            cont.classList.replace('scale-100', 'scale-90');
            cont.classList.replace('opacity-100', 'opacity-0');

            setTimeout(() => {
                m.classList.replace('flex', 'hidden');
                m.classList.add('hidden');
                document.getElementById('zoomedImg').src = "";
            }, 300);
        }

        /* ── Jurus Logout Modal ── */
        function showLogoutModal() {
            const m = document.getElementById('logoutModal');
            const c = document.getElementById('logoutModalContent');
            m.classList.remove('hidden');
            m.classList.add('flex');
            setTimeout(() => {
                c.classList.add('scale-100', 'opacity-100');
                c.classList.remove('scale-90', 'opacity-0');
            }, 10);
        }

        function hideLogoutModal() {
            const m = document.getElementById('logoutModal');
            const c = document.getElementById('logoutModalContent');
            c.classList.replace('scale-100', 'scale-90');
            c.classList.replace('opacity-100', 'opacity-0');
            setTimeout(() => {
                m.classList.replace('flex', 'hidden');
            }, 300);
        }

        function previewAll() {
            if (!filteredData || filteredData.length === 0) {
                alert("Tidak ada data untuk dipreview.");
                return;
            }
            sessionStorage.setItem('recap_data', JSON.stringify(filteredData));
            window.location.href = 'recap.html';
        }

        function closeDetail() {
            document.getElementById('detailView').classList.add('translate-y-full');
            setTimeout(() => document.getElementById('detailView').classList.add('hidden'), 500);
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterPenyulang').value = 'all';
            setQuickStatus('all');
        }

        fetchData();
    </script>
</body>

</html>